<!DOCTYPE html>
<html lang="ar" dir="rtl"> <!-- set to ar/rtl; change to en/ltr if you want English first -->
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>A Candle for You – Sept 25</title>

  <style>
    :root{ --bg:#0b1020; --text:#f5f7ff; --wax:#f4f4ee; --wick:#1a1a1a; }
    html,body{height:100%}
    body{
      margin:0; display:grid; place-items:center;
      min-height:100vh; min-height:100svh; min-height:100dvh;
      background:radial-gradient(1200px 800px at 50% 20%, #17203a 0%, var(--bg) 60%);
      font-family: "Tajawal","Noto Naskh Arabic","Amiri",
                   system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans";
      color:var(--text); -webkit-text-size-adjust:100%;
      -webkit-tap-highlight-color:transparent; touch-action:manipulation; overflow:hidden;
    }
    .message, .premessage{ direction: rtl } /* RTL for Arabic */

    .stage{ position:relative; width:clamp(320px,92vw,760px); height:min(92vh,92svh,92dvh); display:grid; place-items:center }
    svg{ width:100%; height:100%; shape-rendering:geometricPrecision; filter: drop-shadow(0 10px 18px rgba(0,0,0,.45)) }

    /* Stars */
    .stars{ position:absolute; inset:0; pointer-events:none; opacity:.18 }
    .stars span{ position:absolute; width:2px; height:2px; background:white; border-radius:50%; animation: twinkle 4s ease-in-out infinite }
    @keyframes twinkle{ 50%{ transform:scale(1.8); opacity:.4 } }

    /* Candle */
    #candle{ pointer-events:none }
    #candle .body{ fill:var(--wax); stroke:#dddcd4; stroke-width:2; vector-effect:non-scaling-stroke }
    #candle .drip{ fill:#ffffff33 }
    #candle .wick{ fill:var(--wick) }
    #candle .flame{ filter: drop-shadow(0 0 8px rgba(255,190,70,.65)); transform-box:fill-box; transform-origin:50% 100%; opacity:1 }
    .lit #candle .flame{ animation: candleFlicker 120ms ease-in-out infinite alternate }
    @keyframes candleFlicker{ from{ transform:translateX(-.4px) scaleY(1.02); opacity:.95 } to{ transform:translateX(.6px) scaleY(.92) skewX(.6deg); opacity:.85 } }

    .out #candle .flame{ animation:none; opacity:0; transform:translateX(12px) scaleY(1.6); transition:opacity .22s ease, transform .22s ease }
    #candle .smoke circle{ opacity:0 }
    .out #candle .smoke .p1{ animation:puff 1100ms ease-out 40ms both }
    .out #candle .smoke .p2{ animation:puff 1150ms ease-out 140ms both }
    .out #candle .smoke .p3{ animation:puff 1200ms ease-out 240ms both }
    @keyframes puff{
      0%{ transform: translateY(0) translateX(0) scale(.9); opacity:0 }
      20%{ opacity:.5 } 60%{ opacity:.35 }
      100%{ transform: translateY(-30px) translateX(10px) scale(1.35); opacity:0 }
    }

    /* Messages */
    .premessage{
      position:absolute; left:0; right:0;
      bottom:calc(16% + env(safe-area-inset-bottom,0px));
      text-align:center; opacity:0; transform: translateY(6px);
      letter-spacing:.3px; padding-inline: clamp(8px,4vw,24px);
      font-weight:600; font-size: clamp(14px, 3.6vw, 20px);
      z-index:2; text-shadow: 0 1px 2px rgba(0,0,0,.45)
    }
    .premessage.show{ transition: opacity 500ms ease, transform 500ms ease; opacity:1; transform:none }

    .message{
      position:absolute; left:0; right:0;
      bottom:calc(6% + env(safe-area-inset-bottom,0px));
      text-align:center; opacity:0; transform: translateY(8px);
      letter-spacing:.3px; padding-inline: clamp(8px,4vw,24px)
    }
    .message.show{ transition: opacity 800ms ease, transform 800ms ease; opacity:1; transform:none }
    .message .line1{ font-weight:700; font-size: clamp(18px, 5vw, 30px) }
    .message .line2{ margin-top:.35rem; font-weight:500; opacity:.9; font-size: clamp(14px, 3.2vw, 18px) }
  </style>
</head>
<body>
  <div class="stage" id="stage">
    <div class="stars" id="stars" aria-hidden="true"></div>

    <svg viewBox="0 0 750 850" preserveAspectRatio="xMidYMid meet" role="img" aria-label="Candle">
      <g id="candle" transform="translate(375, 500)">
        <defs>
          <radialGradient id="flameGrad" cx="50%" cy="35%" r="70%">
            <stop offset="0%"   stop-color="#fff7a8"/>
            <stop offset="35%"  stop-color="#ffd060"/>
            <stop offset="70%"  stop-color="#ff7e2d"/>
            <stop offset="100%" stop-color="#ff7e2d" stop-opacity="0"/>
          </radialGradient>
        </defs>
        <!-- Body -->
        <rect class="body" x="-16" y="-120" width="32" height="120" rx="8"/>
        <path class="drip" d="M-10 -112 C -2 -108, 4 -110, 12 -112 C 10 -106, -4 -106, -10 -112 Z"/>
        <rect class="wick" x="-1.5" y="-128" width="3" height="10" rx="1"/>
        <!-- Flame -->
        <g class="flame">
          <path d="M0 -136 C 7 -124, 7 -110, 0 -100 C -7 -110, -7 -124, 0 -136 Z" fill="url(#flameGrad)"/>
          <circle cx="-2" cy="-114" r="2.4" fill="#fff9d0" opacity=".85"/>
        </g>
        <!-- Smoke (hidden until out) -->
        <g class="smoke">
          <circle class="p1" cx="0" cy="-132" r="4" fill="#b9b9b9"/>
          <circle class="p2" cx="4" cy="-136" r="3" fill="#c4c4c4"/>
          <circle class="p3" cx="-3" cy="-138" r="3" fill="#cecece"/>
        </g>
      </g>
    </svg>

    <!-- Shows WHILE lit -->
    <div class="premessage" id="preMsg"></div>

    <!-- Shows AFTER blow-out -->
    <div class="message" id="msg" aria-live="polite">
      <div class="line1"></div>
      <div class="line2"></div>
    </div>

    <!-- Song (plays after blow-out). No whoosh. Chime is fallback if no song. -->
    <audio id="song" preload="auto" crossorigin="anonymous"
      src="https://raw.githubusercontent.com/EL-Magnific-o/pic/main/121.mp3"></audio>
    <audio id="sChime" preload="auto"></audio>
  </div>

  <script>
    /********** TEXT & LANGUAGE **********/
    // true = Arabic, false = English
    const USE_ARABIC = true;

    const TEXT = {
      en: {
        pre:   "At midnight, close your eyes and make a wish.",
        line1: "For you, in quiet light. 🕯️",
        line2: "Always and only you."
      },
      ar: {
        pre:   "عند منتصف الليل، أغمِضي عينيك وتمنَّي أمنية.",
        line1: "اَلْيَوْمُ هُوَ عِيدُ مِيلَادِكِ، أَتَظُنِّينِي نَسِيتُ؟ كَيْفَ لِي أَنْ أَغْفُلَ عَنْ هَذَا الْيَوْمِ؟ لَمْ أُجَهِّزْ هَدِيَّةً، فَكُلُّ الْهَدَايَا تَضِيعُ حِينَ تُقَارَنُ بِكِ، لَكِنِّي جِئْتُ بِكَلِمَاتِي وَهِيَ أَغْلَى مَا أَمْلِكُ... لِأُهْدِيَهَا لِقَلْبِكِ❤️.",
        line2: "كُلُّ عَامٍ وَأَنْتِ بِخَيْرٍ، رِيُومِي."
      }
    };
    /*************************************/

    const $stage = document.getElementById('stage');
    const $msg   = document.getElementById('msg');
    const $pre   = document.getElementById('preMsg');

    // Stars
    (function makeStars(){
      const box=document.getElementById('stars'); const n=80;
      for(let i=0;i<n;i++){
        const s=document.createElement('span');
        s.style.left=Math.random()*100+'%';
        s.style.top=Math.random()*100+'%';
        s.style.animationDelay=(Math.random()*4)+'s';
        box.appendChild(s);
      }
    })();

    // Apply language
    (function applyLang(){
      const t = USE_ARABIC ? TEXT.ar : TEXT.en;
      if (USE_ARABIC) { document.documentElement.lang='ar'; document.documentElement.dir='rtl'; }
      else            { document.documentElement.lang='en'; document.documentElement.dir='ltr'; document.body.classList.remove('rtl'); }
      $pre.textContent = t.pre;
      $msg.querySelector('.line1').textContent = t.line1;
      $msg.querySelector('.line2').textContent = t.line2;
    })();

    // Riyadh date helper
    function todayInRiyadh(){
      const now = new Date();
      const parts = new Intl.DateTimeFormat('en-GB', { timeZone:'Asia/Riyadh', year:'numeric', month:'2-digit', day:'2-digit' }).formatToParts(now);
      return {
        y:+parts.find(p=>p.type==='year').value,
        m:+parts.find(p=>p.type==='month').value,
        d:+parts.find(p=>p.type==='day').value
      };
    }

    // Audio: song + optional chime
    const elSong = document.getElementById('song');
    const elChime = document.getElementById('sChime');
    let audioCtx;

    function ensureCtx(){ try{ return audioCtx||(audioCtx=new (window.AudioContext||window.webkitAudioContext)()); }catch(e){ return null; } }

    function startSong(){
      if(!elSong) return;
      try{ elSong.muted=false; elSong.volume=0; }catch(_){}
      const tryPlay = ()=> elSong.play().catch(()=>{});
      tryPlay();
      // fade in to 0.85
      let v=0, target=0.85; const step=0.05;
      const id=setInterval(()=>{ v=Math.min(target, v+step); try{ elSong.volume=v; }catch(_){}
        if(v>=target) clearInterval(id);
      }, 120);
    }

    // Optional simple chime if no song is provided
    function playChime(){
      if(elSong && elSong.src) return; // don’t chime if a song is present
      const ctx=ensureCtx(); if(!ctx) return;
      const now=ctx.currentTime; const g=ctx.createGain(); g.gain.value=.0001; g.connect(ctx.destination);
      const o1=ctx.createOscillator(), o2=ctx.createOscillator();
      o1.type='sine'; o2.type='sine';
      o1.frequency.setValueAtTime(880,now); o2.frequency.setValueAtTime(1318.5,now);
      const eg=ctx.createGain(); eg.gain.setValueAtTime(.0001,now); eg.gain.exponentialRampToValueAtTime(.4,now+.03); eg.gain.exponentialRampToValueAtTime(.0001,now+1.2);
      o1.connect(eg).connect(g); o2.connect(eg);
      o1.start(now); o2.start(now); o1.stop(now+1.25); o2.stop(now+1.25);
    }

    // Try to satisfy autoplay policies:
    // 1) Start song muted at load (some browsers allow), 2) Unmute/play on first tap
    (function prepAutoplay(){
      if(elSong){
        try{ elSong.muted = true; elSong.volume = 0; }catch(_){}
        elSong.play().catch(()=>{ /* ignored */ });
      }
      window.addEventListener('pointerdown', ()=>{
        if (audioCtx && audioCtx.state==='suspended') audioCtx.resume();
        if (elSong){ elSong.muted=false; elSong.play().catch(()=>{}); }
      }, {once:true});
    })();

    // Sequence
    function showPre(){ $pre.classList.add('show'); }
    function hidePre(){ $pre.classList.remove('show'); }
    function blowOut(){ if(!$stage.classList.contains('out')){ $stage.classList.add('out'); startSong(); } }
    function showMsg(){ $msg.classList.add('show'); playChime(); }

    function runSequence(){
      $stage.classList.add('lit');        // candle flickers
      showPre();                          // show line while lit
      setTimeout(()=>{ hidePre(); blowOut(); }, 1300); // then blow out
      setTimeout(()=>{ showMsg(); }, 2300);            // then final message
    }

    (function init(){
      // Candle appears lit immediately
      $stage.classList.add('lit');

      // Force / preview detection (query OR hash); local files auto-run
      const q = new URLSearchParams(location.search||'');
      const hashRaw = (location.hash||'').slice(1);
      const h = new URLSearchParams(hashRaw && !hashRaw.includes('=') ? `force=${hashRaw}` : hashRaw);
      const truthy = v => v && ['1','true','yes','on','y'].includes(String(v).toLowerCase());
      const force = truthy(q.get('force')) || truthy(h.get('force')) || truthy(q.get('debug')) || truthy(h.get('debug'));

      const {m,d} = todayInRiyadh();
      const isSept25 = (m===9 && d===25);
      const isFile = location.protocol === 'file:';

      if (isSept25 || force || isFile) runSequence();

      $msg.addEventListener('transitionend', (e)=>{
        if(e.propertyName==='opacity' && $msg.classList.contains('show')){
          $msg.setAttribute('aria-label','The candle has been blown out and a message is displayed.');
        }
      });
    })();
  </script>
</body>
</html>
